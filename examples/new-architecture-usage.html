<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapLibre LayerLibre - Five-Service Architecture Example</title>
  <link href="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist/stylesheet.min.css">
  <link href="../dist/css/all.css" rel="stylesheet">
  <style>
    html, body, #map { height: 100%; margin: 0; padding: 0; }
    #map { width: 100vw; height: 100vh; }
    .panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      max-width: 300px;
      z-index: 1000;
      font-family: Arial, sans-serif;
      font-size: 13px;
    }
    .panel h3 { margin: 0 0 10px 0; font-size: 15px; }
    .panel button {
      display: block;
      width: 100%;
      margin: 4px 0;
      padding: 7px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      text-align: left;
    }
    .panel button:hover { background: #f0f0f0; }
    .log {
      margin-top: 10px;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 4px;
      max-height: 160px;
      overflow-y: auto;
      font-size: 11px;
      font-family: monospace;
    }
    .log-entry { margin: 2px 0; color: #333; }
    .log-entry.base { color: #0066cc; }
    .log-entry.overlay { color: #007744; }
    .log-entry.error { color: #cc0000; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel">
    <h3>Five-Service Architecture</h3>
    <button onclick="addDynamicOverlay()">Add Dynamic Overlay</button>
    <button onclick="removeDynamicOverlay()">Remove Dynamic Overlay</button>
    <button onclick="switchBase('osm')">Switch to OSM</button>
    <button onclick="switchBase('satellite')">Switch to Satellite</button>
    <button onclick="logState()">Log Current State</button>
    <button onclick="clearStorage()">Clear Persisted State</button>
    <div class="log" id="log"></div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist.min.js"></script>
  <script src="../dist/js/all.min.js"></script>
  <script>
    // ── Logging helper ────────────────────────────────────────────────────
    function log(msg, type) {
      const el = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry' + (type ? ' ' + type : '');
      entry.textContent = new Date().toLocaleTimeString() + ' ' + msg;
      el.insertBefore(entry, el.firstChild);
    }

    // ── Configuration ─────────────────────────────────────────────────────
    const baseStyles = [
      {
        id: 'osm',
        label: 'OpenStreetMap',
        style: 'https://demotiles.maplibre.org/style.json',
        strategy: 'setStyle'
      },
      {
        id: 'satellite',
        label: 'Satellite',
        style: {
          version: 8,
          sources: {
            satellite: {
              type: 'raster',
              tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
              tileSize: 256,
              attribution: '© Esri'
            }
          },
          layers: [{ id: 'satellite-layer', type: 'raster', source: 'satellite' }]
        },
        strategy: 'setStyle'
      }
    ];

    const overlays = [
      {
        id: 'static-points',
        label: 'Static Points',
        deckLayers: [
          {
            id: 'static-points-layer',
            type: 'ScatterplotLayer',
            props: {
              data: [
                { position: [-74.0, 40.7], name: 'New York' },
                { position: [-87.6, 41.9], name: 'Chicago' },
                { position: [-118.2, 34.0], name: 'Los Angeles' }
              ],
              getPosition: d => d.position,
              getRadius: 20000,
              getFillColor: [255, 100, 0],
              getLineColor: [255, 255, 255],
              lineWidthMinPixels: 2,
              pickable: true
            }
          }
        ],
        tooltip: 'name',
        defaultVisible: false,
        opacityControls: true
      },
      {
        id: 'async-overlay',
        label: 'Async Data (onChecked)',
        onChecked: async (context) => {
          if (context.getCache()) return;
          log('Fetching async data…', 'overlay');
          // Simulate async data fetch
          await new Promise(r => setTimeout(r, 800));
          const data = [
            { position: [-73.9, 40.8], name: 'Point A' },
            { position: [-73.8, 40.7], name: 'Point B' },
            { position: [-74.1, 40.6], name: 'Point C' }
          ];
          context.setOverlayConfig({
            deckLayers: [{
              id: 'async-layer',
              type: 'ScatterplotLayer',
              props: {
                data,
                getPosition: d => d.position,
                getRadius: 10000,
                getFillColor: [0, 180, 255],
                getLineColor: [255, 255, 255],
                lineWidthMinPixels: 2,
                pickable: true
              }
            }]
          });
          context.setCache({ loaded: true });
          log('Async data loaded (' + data.length + ' points)', 'overlay');
        },
        tooltip: 'name',
        defaultVisible: false
      }
    ];

    // ── Five-service instantiation ─────────────────────────────────────────
    const eventEmitter        = new EventEmitter();
    const stateService        = new StateService(eventEmitter, 'new-architecture-example');
    const mapService          = new MapService(eventEmitter);
    const uiService           = new UIService(stateService, mapService, eventEmitter);
    const businessLogicService = new BusinessLogicService(stateService, eventEmitter);

    const layersControl = new LayersControl(
      {
        baseStyles,
        overlays,
        defaultBaseId: 'osm',
        showOpacity: true,
        autoClose: false,
        icon: '☰',
        i18n: { baseHeader: 'Base Layers', overlaysHeader: 'Overlays' }
      },
      { stateService, uiService, mapService, businessLogicService, eventEmitter }
    );

    // ── Map ───────────────────────────────────────────────────────────────
    const map = new maplibregl.Map({
      container: 'map',
      style: baseStyles[0].style,
      center: [-95, 40],
      zoom: 3
    });

    map.addControl(layersControl, 'top-left');

    // ── Event listeners ───────────────────────────────────────────────────
    layersControl
      .on('basechange',    e => log('basechange → ' + e.id, 'base'))
      .on('overlaychange', e => log('overlaychange → ' + e.id + ' ' + (e.visible ? 'on' : 'off'), 'overlay'))
      .on('loading',       e => log('loading → ' + e.id))
      .on('success',       e => log('success → ' + e.id))
      .on('error',         e => log('error → ' + e.id + ': ' + e.error, 'error'))
      .on('styleload',     e => log('styleload → ' + e.baseId, 'base'));

    // ── Control panel actions ─────────────────────────────────────────────
    let dynamicAdded = false;

    function addDynamicOverlay() {
      if (dynamicAdded) { log('Dynamic overlay already added'); return; }
      layersControl.addOverlay({
        id: 'dynamic-overlay',
        label: 'Dynamic (runtime added)',
        deckLayers: [{
          id: 'dynamic-layer',
          type: 'ScatterplotLayer',
          props: {
            data: [{ position: [-77.0, 38.9], name: 'Washington DC' }],
            getPosition: d => d.position,
            getRadius: 15000,
            getFillColor: [200, 0, 200],
            pickable: true
          }
        }],
        tooltip: 'name',
        defaultVisible: true,
        opacityControls: true
      });
      dynamicAdded = true;
      log('Dynamic overlay added');
    }

    function removeDynamicOverlay() {
      if (!dynamicAdded) { log('No dynamic overlay to remove'); return; }
      layersControl.removeOverlay('dynamic-overlay');
      dynamicAdded = false;
      log('Dynamic overlay removed');
    }

    function switchBase(id) {
      layersControl.setBaseLayer(id);
    }

    function logState() {
      const state = layersControl.getCurrentState();
      log('state → ' + JSON.stringify(state).slice(0, 120) + '…');
      console.log('Current state:', state);
    }

    function clearStorage() {
      layersControl.clearPersistedData();
      log('Persisted state cleared');
    }
  </script>
</body>
</html>
