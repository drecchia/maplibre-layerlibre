<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<title>LayersControl Advanced Features Example</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- MapLibre GL CSS -->
	<link href="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist/stylesheet.min.css">
	<link href="../dist/css/all.css" rel="stylesheet">
	<style>
		html,
		body,
		#map {
			height: 100%;
			margin: 0;
			padding: 0;
		}

		#map {
			width: 100vw;
			height: 100vh;
		}

		.test-info {
			position: absolute;
			top: 10px;
			right: 10px;
			background: white;
			padding: 15px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
			max-width: 300px;
			z-index: 1000;
		}

		.test-info h3 {
			margin: 0 0 10px 0;
			color: #333;
		}

		.test-info ul {
			margin: 0;
			padding-left: 20px;
		}

		.test-info li {
			margin-bottom: 5px;
			font-size: 14px;
		}
	</style>
</head>

<body>
	<div id="map"></div>
	<div class="test-info">
		<h3>ðŸ§ª Advanced Features</h3>
		<ul>
			<li>Advanced features: Try overlays with anchor, group, forced base, loading/error, and more.</li>
			<li>Toggle overlays and groups, zoom, and interact with the UI.</li>
		</ul>
	</div>
	<!-- MapLibre GL JS -->
	<script src="https://unpkg.com/maplibre-gl@4.1.1/dist/maplibre-gl.js"></script>
	<!-- Deck.gl CDN -->
	<script src="https://cdn.jsdelivr.net/npm/deck.gl@9.1.14/dist.min.js"></script>
	<!-- LayersControl JS -->
	<script src="../dist/js/all.min.js"></script>
	<script>
		const baseStyles = [
			{
				id: 'osm',
				label: 'OpenStreetMap',
				style: 'https://demotiles.maplibre.org/style.json',
				strategy: 'setStyle'
			},
			{
				id: 'satellite',
				label: 'Satellite',
				style: {
					version: 8,
					sources: {
						'satellite': {
							type: 'raster',
							tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
							tileSize: 256,
							attribution: 'Â© Esri'
						}
					},
					layers: [
						{
							id: 'satellite-layer',
							type: 'raster',
							source: 'satellite'
						}
					]
				},
				strategy: 'setStyle'
			}
		];

		const overlays = [
			{
				id: 'anchor-overlay',
				label: 'Anchored Overlay',
				group: 'Default',
				deckLayers: [
					{
						id: 'anchor-layer',
						type: 'ScatterplotLayer',
						props: {
							data: [
								{ position: [-43.1729, -22.9068], name: 'Rio de Janeiro' }
							],
							getPosition: d => d.position,
							getRadius: 4000,
							getFillColor: [255, 0, 0], // red
							getLineColor: [255, 255, 255],
							lineWidthMinPixels: 2,
							pickable: true
						}
					}
				],
				defaultVisible: false,
				viewport: {
					zoom: 12,
					center: [-43.1729, -22.9068]
				}
			},
			{
				id: 'group-overlay-1',
				label: 'Group Overlay 1',
				group: 'Advanced Group',
				deckLayers: [
					{
						id: 'group-overlay-1-layer',
						type: 'ScatterplotLayer',
						props: {
							data: [
								{ position: [-46.6333, -23.5505], name: 'SÃ£o Paulo' }
							],
							getPosition: d => d.position,
							getRadius: 14000,
							getFillColor: [0, 0, 255], // blue
							getLineColor: [255, 255, 255],
							lineWidthMinPixels: 2,
							pickable: true
						}
					}
				],
				viewport: {
					zoom: 10,
					center: [-46.6333, -23.5505],
					pitch: 0,
					bearing: 0
				},
				defaultVisible: false
			},
			{
				id: 'group-overlay-2',
				label: 'Group Overlay 2',
				group: 'Advanced Group',
				deckLayers: [
					{
						id: 'group-overlay-2-layer',
						type: 'ScatterplotLayer',
						props: {
							data: [
								{ position: [-38.5167, -12.9704], name: 'Salvador' }
							],
							getPosition: d => d.position,
							getRadius: 14000,
							getFillColor: [128, 0, 128], // purple
							getLineColor: [255, 255, 255],
							lineWidthMinPixels: 2,
							pickable: true
						}
					}
				],
				viewport: {
					zoom: 12,
					center: [-38.5167, -12.9704],
					pitch: 0,
					bearing: 0
				},
				defaultVisible: false
			},
			{
				id: 'forced-viewport',
				label: 'Force Satellite + Tilt',
				group: 'Default',
				deckLayers: [
					{
						id: 'forced-viewport-layer',
						type: 'ScatterplotLayer',
						props: {
							data: [
								{ position: [-48.5011, -27.5954], name: 'FlorianÃ³polis' }
							],
							getPosition: d => d.position,
							getRadius: 4000,
							getFillColor: [128, 0, 128], // purple
							getLineColor: [255, 255, 255],
							lineWidthMinPixels: 3,
							pickable: true
						}
					}
				],
				forcedBaseLayerId: 'satellite',
				viewport: {
					zoom: 14,
					pitch: 60,
					bearing: 45,
				},
				defaultVisible: false
			},
			{
				id: 'error-overlay',
				label: 'Error Overlay (onChecked)',
				group: 'Loading Status',
				onChecked: async (context) => {
					// Simulate error
					await new Promise(resolve => setTimeout(resolve, 500));
					throw new Error('Simulated error loading overlay data');
				},
				defaultVisible: false
			},
			{
				id: 'loading-overlay',
				label: 'Loading Overlay (onChecked)',
				group: 'Loading Status',
				onChecked: async (context) => {
					// Simulate loading
					await new Promise(resolve => setTimeout(resolve, 2000));

					// Update overlay configuration
					context.setOverlayConfig({
						deckLayers: [
							{
								id: 'loading-layer',
								type: 'ScatterplotLayer',
								props: {
									data: [
										{ position: [-35.2094, -5.7945], name: 'Natal' }
									],
									getPosition: d => d.position,
									getRadius: 4000,
									getFillColor: [255, 0, 0], // red
									getLineColor: [0, 0, 255], // blue
									lineWidthMinPixels: 2,
									pickable: true
								}
							}
						],
					});
				},
				defaultVisible: false,
				viewport: {
					zoom: 13,
					center: [-35.2094, -5.7945]
				},
			}
		];

		const eventEmitter = new EventEmitter();
		const stateService = new StateService(eventEmitter, 'layersControlState');
		const mapService = new MapService(eventEmitter);
		const uiService = new UIService(stateService, mapService, eventEmitter);
		const businessLogicService = new BusinessLogicService(stateService, eventEmitter);

		const map = new maplibregl.Map({
			container: 'map',
			style: baseStyles[0].style,
			center: [-47.5, -23.1],
			zoom: 10
		});

		const layersControl = new LayersControl({
			baseStyles: baseStyles,
			overlays: overlays,
			defaultBaseId: 'osm'
		}, {
			stateService,
			uiService,
			mapService,
			businessLogicService,
			eventEmitter
		});

		map.addControl(layersControl, 'top-left');
	</script>
</body>

</html>
